{% extends "base.html" %}

{% block title %}Duyurular - Xcrover Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üì¢ Duyurular</h1>
    <button class="btn btn-primary" onclick="document.getElementById('addModal').classList.add('active')">
        ‚ûï Yeni Duyuru Olu≈ütur
    </button>
</div>

<div class="search-section">
    <input type="text" id="announcementSearch" placeholder="üîç Duyuru ara..." onkeyup="handleSearch()">
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Ba≈ülƒ±k</th>
                <th>Durum</th>
                <th>Olu≈üturma Tarihi</th>
                <th>Olu≈üturan</th>
                <th>ƒ∞≈ülemler</th>
            </tr>
        </thead>
        <tbody id="announcementsTableBody">
            {% if announcements %}
                {% for announcement in announcements %}
                <tr>
                    <td><strong>{{ announcement.title }}</strong></td>
                    <td>
                        {% if announcement.isActive %}
                            <span class="badge badge-success">‚úÖ Aktif</span>
                        {% else %}
                            <span class="badge badge-secondary">‚è∏Ô∏è Pasif</span>
                        {% endif %}
                    </td>
                    <td>{{ announcement.createdAt.strftime('%d.%m.%Y %H:%M') if announcement.createdAt else '-' }}</td>
                    <td>{{ announcement.createdBy or 'System' }}</td>
                    <td style="display: flex; gap: 6px;">
                        {% if announcement.isActive %}
                            <button class="btn btn-sm btn-warning" onclick="toggleAnnouncement('{{ announcement._id }}')">
                                ‚è∏Ô∏è Pasif Yap
                            </button>
                        {% else %}
                            <button class="btn btn-sm btn-success" onclick="toggleAnnouncement('{{ announcement._id }}')">
                                ‚úÖ Aktif Yap
                            </button>
                        {% endif %}
                        <button class="btn btn-sm btn-danger" onclick="deleteAnnouncement('{{ announcement._id }}')">
                            üóë Sil
                        </button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 20px; opacity: 0.6;">
                        Hen√ºz duyuru olu≈üturulmamƒ±≈ü
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Yeni Duyuru Olu≈ütur</h3>
            <button class="modal-close" onclick="document.getElementById('addModal').classList.remove('active')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Ba≈ülƒ±k</label>
                <input type="text" id="title" placeholder="Duyuru ba≈ülƒ±ƒüƒ±..." required>
            </div>
            <div class="form-group">
                <label>ƒ∞√ßerik</label>
                <textarea id="body" rows="6" placeholder="Duyuru i√ßeriƒüi..." required></textarea>
            </div>
            <div class="form-group">
                <label>G√∂rsel URL (Opsiyonel)</label>
                <input type="url" id="imageUrl" placeholder="https://...">
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="isActive" checked>
                    Hemen aktif et
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('addModal').classList.remove('active')">ƒ∞ptal</button>
            <button class="btn btn-primary" onclick="addAnnouncement()">Olu≈ütur</button>
        </div>
    </div>
</div>

<script>
function handleSearch() {
    const searchValue = document.getElementById('announcementSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#announcementsTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
}

async function addAnnouncement() {
    const title = document.getElementById('title').value.trim();
    const body = document.getElementById('body').value.trim();
    const imageUrl = document.getElementById('imageUrl').value.trim();
    const isActive = document.getElementById('isActive').checked;
    
    if (!title || !body) {
        alert('Ba≈ülƒ±k ve i√ßerik gerekli!');
        return;
    }
    
    try {
        const res = await fetch('/announcements/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                title: title,
                body: body,
                imageUrl: imageUrl,
                isActive: isActive
            })
        });
        const data = await res.json();
        
        if (data.success) {
            alert('Duyuru olu≈üturuldu!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        alert('ƒ∞stek hatasƒ±: ' + e);
    }
}

async function toggleAnnouncement(announcementId) {
    console.log('[Toggle] Announcement ID:', announcementId);
    
    try {
        const res = await fetch(`/announcements/toggle/${announcementId}`, { 
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        console.log('[Toggle] Response status:', res.status);
        const data = await res.json();
        console.log('[Toggle] Response data:', data);
        
        if (data.success) {
            alert('Durum g√ºncellendi!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        console.error('[Toggle] Error:', e);
        alert('ƒ∞stek hatasƒ±: ' + e.message);
    }
}

async function deleteAnnouncement(announcementId) {
    if (!confirm('Bu duyuruyu silmek istediƒüinizden emin misiniz?')) return;
    
    try {
        const res = await fetch(`/announcements/delete/${announcementId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert('Duyuru silindi!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        alert('ƒ∞stek hatasƒ±');
    }
}
</script>
{% endblock %}
