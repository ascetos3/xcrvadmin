{% extends "base.html" %}

{% block title %}G√ºncellemeler - Xcrover Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üîÑ Uygulama G√ºncellemeleri</h1>
    <button class="btn btn-primary" onclick="document.getElementById('addModal').classList.add('active')">
        ‚ûï Yeni G√ºncelleme Ekle
    </button>
</div>

<div class="search-section">
    <input type="text" id="updateSearch" placeholder="üîç G√ºncelleme ara..." onkeyup="handleSearch()">
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Versiyon</th>
                <th>Zorunlu</th>
                <th>Changelog</th>
                <th>ƒ∞ndirme</th>
                <th>Tarih</th>
                <th>ƒ∞≈ülemler</th>
            </tr>
        </thead>
        <tbody id="updatesTableBody">
            {% if updates %}
                {% for update in updates %}
                <tr>
                    <td><strong><code>v{{ update.version }}</code></strong></td>
                    <td>
                        {% if update.isMandatory %}
                            <span class="badge badge-danger">‚ö†Ô∏è Zorunlu</span>
                        {% else %}
                            <span class="badge badge-info">‚ÑπÔ∏è Opsiyonel</span>
                        {% endif %}
                    </td>
                    <td><small>{{ update.changelog[:60] if update.changelog else '-' }}{{ '...' if update.changelog and update.changelog|length > 60 else '' }}</small></td>
                    <td><a href="{{ update.downloadUrl }}" target="_blank" class="link-primary">üîó ƒ∞ndir</a></td>
                    <td>{{ update.createdAt.strftime('%d.%m.%Y') if update.createdAt else '-' }}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteUpdate('{{ update._id }}')">
                            üóë Sil
                        </button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; opacity: 0.6;">
                        Hen√ºz g√ºncelleme eklenmemi≈ü
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Yeni G√ºncelleme Ekle</h3>
            <button class="modal-close" onclick="document.getElementById('addModal').classList.remove('active')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Versiyon</label>
                <input type="text" id="version" placeholder="√ñrn: 1.5.0" required>
            </div>
            <div class="form-group">
                <label>ƒ∞ndirme Linki</label>
                <input type="url" id="downloadUrl" placeholder="https://..." required>
            </div>
            <div class="form-group">
                <label>Deƒüi≈üiklik Notlarƒ± (Changelog)</label>
                <textarea id="changelog" rows="6" placeholder="- Yeni √∂zellik eklendi&#10;- Bug d√ºzeltmeleri&#10;- Performans iyile≈ütirmeleri"></textarea>
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="isMandatory">
                    Zorunlu g√ºncelleme
                </label>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="document.getElementById('addModal').classList.remove('active')">ƒ∞ptal</button>
            <button class="btn btn-primary" onclick="addUpdate()">Ekle</button>
        </div>
    </div>
</div>

<script>
function handleSearch() {
    const searchValue = document.getElementById('updateSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#updatesTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
}

async function addUpdate() {
    const version = document.getElementById('version').value.trim();
    const downloadUrl = document.getElementById('downloadUrl').value.trim();
    const changelog = document.getElementById('changelog').value.trim();
    const isMandatory = document.getElementById('isMandatory').checked;
    
    if (!version || !downloadUrl) {
        alert('Versiyon ve indirme linki gerekli!');
        return;
    }
    
    try {
        const res = await fetch('/updates/add', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                version: version,
                downloadUrl: downloadUrl,
                changelog: changelog,
                isMandatory: isMandatory
            })
        });
        const data = await res.json();
        
        if (data.success) {
            alert('G√ºncelleme eklendi!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        alert('ƒ∞stek hatasƒ±: ' + e);
    }
}

async function deleteUpdate(updateId) {
    if (!confirm('Bu g√ºncellemeyi silmek istediƒüinizden emin misiniz?')) return;
    
    try {
        const res = await fetch(`/updates/delete/${updateId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert('G√ºncelleme silindi!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        alert('ƒ∞stek hatasƒ±');
    }
}
</script>
{% endblock %}
