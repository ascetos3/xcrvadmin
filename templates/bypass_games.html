{% extends "base.html" %}

{% block title %}Bypass Paketleri - Xcrover Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üõ°Ô∏è Bypass Paketleri</h1>
    <button class="btn btn-primary" onclick="document.getElementById('addModal').classList.add('active')">
        ‚ûï Yeni Bypass Paketi Ekle
    </button>
</div>

<div class="search-section">
    <input type="text" id="packageSearch" placeholder="üîç Paket ara..." onkeyup="handleSearch()">
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Paket Adƒ±</th>
                <th>Hedef Yol</th>
                <th>Dosya</th>
                <th>Boyut</th>
                <th>Eklenme Tarihi</th>
                <th>ƒ∞≈ülemler</th>
            </tr>
        </thead>
        <tbody id="packagesTableBody">
            {% if packages %}
                {% for pkg in packages %}
                <tr>
                    <td><strong>{{ pkg.name or pkg.packageName }}</strong></td>
                    <td><small style="color:#868e96;">{{ pkg.targetPath[:50] if pkg.targetPath else '-' }}{{ '...' if pkg.targetPath and pkg.targetPath|length > 50 else '' }}</small></td>
                    <td>üì¶ {{ pkg.fileName or '-' }}</td>
                    <td>{{ '%.2f'|format((pkg.fileSize or 0) / 1024 / 1024) }} MB</td>
                    <td>{{ pkg.createdAt.strftime('%d.%m.%Y') if pkg.createdAt else '-' }}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deletePackage('{{ pkg._id }}')">
                            üóë Sil
                        </button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; opacity: 0.6;">
                        Hen√ºz bypass paketi eklenmemi≈ü
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<!-- Add Modal -->
<div id="addModal" class="modal">
    <div class="modal-content modal-large">
        <div class="modal-header">
            <h3>Yeni Bypass Paketi Ekle</h3>
            <button class="modal-close" onclick="document.getElementById('addModal').classList.remove('active')">&times;</button>
        </div>
        <form id="uploadForm" onsubmit="addPackage(event)">
            <div class="modal-body">
                <div class="form-group">
                    <label>Paket Adƒ± *</label>
                    <input type="text" id="packageName" name="packageName" placeholder="√ñrn: Red Dead Redemption 2" required>
                </div>
                <div class="form-group">
                    <label>Hedef Yol *</label>
                    <input type="text" id="targetPath" name="targetPath" placeholder="C:\Program Files (x86)\Steam\steamapps\common\GameName" required>
                    <small style="color:#868e96;">Oyunun kurulu olduƒüu klas√∂r yolu</small>
                </div>
                <div class="form-group">
                    <label>ZIP/RAR Dosyasƒ± *</label>
                    <input type="file" id="bypassFile" name="bypassFile" accept=".zip,.rar" required>
                    <small style="color:#868e96;">Maksimum 500 MB</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="document.getElementById('addModal').classList.remove('active')">ƒ∞ptal</button>
                <button type="submit" class="btn btn-primary" id="submitBtn">Y√ºkle</button>
            </div>
        </form>
    </div>
</div>

<!-- Progress Modal -->
<div id="progressModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Dosya Y√ºkleniyor...</h3>
        </div>
        <div class="modal-body" style="text-align: center; padding: 30px;">
            <div style="margin-bottom: 20px;">
                <div class="spinner"></div>
            </div>
            <p id="progressText">L√ºtfen bekleyin...</p>
            <div style="background: #e9ecef; border-radius: 10px; height: 20px; margin-top: 15px;">
                <div id="progressBar" style="background: #28a745; height: 100%; border-radius: 10px; width: 0%; transition: width 0.3s;"></div>
            </div>
        </div>
    </div>
</div>

<style>
.spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #007bff;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

<script>
function handleSearch() {
    const searchValue = document.getElementById('packageSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#packagesTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
}

async function addPackage(event) {
    event.preventDefault();
    
    const packageName = document.getElementById('packageName').value.trim();
    const targetPath = document.getElementById('targetPath').value.trim();
    const fileInput = document.getElementById('bypassFile');
    
    if (!packageName || !targetPath || !fileInput.files.length) {
        alert('T√ºm alanlarƒ± doldurun!');
        return;
    }
    
    const file = fileInput.files[0];
    if (file.size > 500 * 1024 * 1024) {
        alert('Dosya boyutu 500 MB\'dan b√ºy√ºk olamaz!');
        return;
    }
    
    // Show progress modal
    document.getElementById('addModal').classList.remove('active');
    document.getElementById('progressModal').classList.add('active');
    document.getElementById('submitBtn').disabled = true;
    
    const formData = new FormData();
    formData.append('packageName', packageName);
    formData.append('targetPath', targetPath);
    formData.append('bypassFile', file);
    
    try {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/bypass-games/add', true);
        
        xhr.upload.onprogress = function(e) {
            if (e.lengthComputable) {
                const percent = Math.round((e.loaded / e.total) * 100);
                document.getElementById('progressBar').style.width = percent + '%';
                document.getElementById('progressText').textContent = `Y√ºkleniyor... ${percent}%`;
            }
        };
        
        xhr.onload = function() {
            document.getElementById('progressModal').classList.remove('active');
            document.getElementById('submitBtn').disabled = false;
            
            try {
                const data = JSON.parse(xhr.responseText);
                if (data.success) {
                    alert('Bypass paketi eklendi!');
                    location.reload();
                } else {
                    alert('Hata: ' + data.message);
                }
            } catch (e) {
                alert('Sunucu yanƒ±tƒ± i≈ülenemedi');
            }
        };
        
        xhr.onerror = function() {
            document.getElementById('progressModal').classList.remove('active');
            document.getElementById('submitBtn').disabled = false;
            alert('Y√ºkleme hatasƒ±!');
        };
        
        xhr.send(formData);
    } catch (e) {
        document.getElementById('progressModal').classList.remove('active');
        document.getElementById('submitBtn').disabled = false;
        alert('ƒ∞stek hatasƒ±: ' + e);
    }
}

async function deletePackage(packageId) {
    if (!confirm('Bu bypass paketini silmek istediƒüinizden emin misiniz?')) return;
    
    try {
        const res = await fetch(`/bypass-games/delete/${packageId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert('Bypass paketi silindi!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        alert('ƒ∞stek hatasƒ±');
    }
}
</script>
{% endblock %}
