{% extends "base.html" %}

{% block title %}Manuel Oyunlar - Xcrover Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üì¶ Manuel Oyunlar</h1>
</div>

<div class="card" style="margin-bottom: 20px;">
    <h3>Yeni Manuel Oyun Y√ºkle</h3>
    <form id="uploadForm" onsubmit="addGame(event)">
        <div class="form-group">
            <label>Oyun ID (AppId)</label>
            <input type="text" id="appId" name="appId" placeholder="√ñrn: 730" required>
        </div>
        <div class="form-group">
            <label>Oyun Adƒ±</label>
            <input type="text" id="gameName" name="gameName" placeholder="√ñrn: Counter-Strike 2" required>
        </div>
        <div class="form-group">
            <label>ZIP Dosyasƒ±</label>
            <input type="file" id="gameFile" name="gameFile" accept=".zip" required>
            <small style="opacity: 0.7;">Sadece ZIP dosyalarƒ± y√ºklenebilir</small>
        </div>
        <button type="submit" class="btn btn-primary" id="uploadBtn">
            üì§ Y√ºkle
        </button>
    </form>
</div>

<div class="search-section">
    <input type="text" id="gameSearch" placeholder="üîç Oyun ara..." onkeyup="handleSearch()">
</div>

<div class="card">
    <table class="table">
        <thead>
            <tr>
                <th>Oyun ID</th>
                <th>Oyun Adƒ±</th>
                <th>Dosya</th>
                <th>Boyut</th>
                <th>Eklenme Tarihi</th>
                <th>ƒ∞≈ülemler</th>
            </tr>
        </thead>
        <tbody id="gamesTableBody">
            {% if games %}
                {% for game in games %}
                <tr>
                    <td><code>{{ game.appId }}</code></td>
                    <td><strong>{{ game.gameName }}</strong></td>
                    <td><small>{{ game.fileName or '-' }}</small></td>
                    <td>{{ (game.fileSize / 1024 / 1024)|round(2) if game.fileSize else 0 }} MB</td>
                    <td>{{ game.addedAt.strftime('%d.%m.%Y %H:%M') if game.addedAt else '-' }}</td>
                    <td style="display: flex; gap: 6px;">
                        <a href="/manual-games/download/{{ game.appId }}" class="btn btn-sm btn-info" title="ƒ∞ndir">
                            ‚¨áÔ∏è ƒ∞ndir
                        </a>
                        <button class="btn btn-sm btn-danger" onclick="deleteGame('{{ game.appId }}')">
                            üóë Sil
                        </button>
                    </td>
                </tr>
                {% endfor %}
            {% else %}
                <tr>
                    <td colspan="6" style="text-align: center; padding: 20px; opacity: 0.6;">
                        Hen√ºz manuel oyun y√ºklenmemi≈ü
                    </td>
                </tr>
            {% endif %}
        </tbody>
    </table>
</div>

<script>
function handleSearch() {
    const searchValue = document.getElementById('gameSearch').value.toLowerCase();
    const rows = document.querySelectorAll('#gamesTableBody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchValue) ? '' : 'none';
    });
}

async function addGame(event) {
    event.preventDefault();
    
    const appId = document.getElementById('appId').value.trim();
    const gameName = document.getElementById('gameName').value.trim();
    const fileInput = document.getElementById('gameFile');
    const file = fileInput.files[0];
    const uploadBtn = document.getElementById('uploadBtn');
    
    if (!appId || !gameName || !file) {
        alert('L√ºtfen t√ºm alanlarƒ± doldurun!');
        return;
    }
    
    if (!file.name.endsWith('.zip')) {
        alert('Sadece ZIP dosyalarƒ± y√ºklenebilir!');
        return;
    }
    
    uploadBtn.disabled = true;
    uploadBtn.textContent = '‚è≥ Y√ºkleniyor...';
    
    const formData = new FormData();
    formData.append('appId', appId);
    formData.append('gameName', gameName);
    formData.append('gameFile', file);
    
    try {
        const res = await fetch('/manual-games/add', { 
            method: 'POST', 
            body: formData 
        });
        const data = await res.json();
        
        if (data.success) {
            alert('Manuel oyun ba≈üarƒ±yla y√ºklendi!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        alert('ƒ∞stek hatasƒ±: ' + e);
    } finally {
        uploadBtn.disabled = false;
        uploadBtn.textContent = 'üì§ Y√ºkle';
    }
}

async function deleteGame(appId) {
    if (!confirm('Bu manuel oyunu silmek istediƒüinizden emin misiniz?\n\nZIP dosyasƒ± da silinecektir.')) return;
    
    try {
        const res = await fetch(`/manual-games/delete/${appId}`, { method: 'POST' });
        const data = await res.json();
        
        if (data.success) {
            alert('Manuel oyun silindi!');
            location.reload();
        } else {
            alert('Hata: ' + data.message);
        }
    } catch (e) {
        alert('ƒ∞stek hatasƒ±');
    }
}
</script>
{% endblock %}
